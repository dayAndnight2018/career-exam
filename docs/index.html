<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Document</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
        <meta name="description" content="Description">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
        <link rel="stylesheet" href="../css/vue.css">
        <script src="../js/vue.js"></script>
        <!-- Jquery -->
        <script src="../js/jquery.js"></script>
    </head>
    <body>
        <div id="app">
            <div class="window" :style="displayBtn">
                <div class="mainWindow">
                    <img class="previewImage" :src="imageIcon">
                    <span class="closeBtn" @click="closeWindow">Ã—</span>
                </div>
            </div>
        </div>
        
        <script>
            window.$docsify = {
                name: '',
                repo: '',
                loadSidebar: true,
                coverpage: true,
                search: {
                    paths: 'auto',
                    placeholder: 'æœç´¢',
                    noData: 'æ‰¾ä¸åˆ°ç»“æœ',
                    depth: 3
                },
                count: {
                    countable: true,
                    fontsize: '0.9em',
                    color: 'rgb(90,90,90)',
                    language: 'chinese'
                }
            };

            var vue = new Vue({
                el: '#app',
                data:{
                    imageIcon: undefined,
                    active: false,
                },methods: {
                    closeWindow: function () {
                        this.active = !this.active;
                        this.imageIcon = undefined;
                    }
                },
                computed: {
                    displayBtn() {
                        return {
                            '--display-btn': this.active ? 'block' : 'none'
                        }
                    },
                    displayImage() {
                        return {
                            '--display-image': 'url(' + this.imageIcon + ')'
                        }
                    }
                }
            });

            $(function(){
                $("img").each(function(ele){
                    $(this).click(function(){
                        vue.imageIcon = $(this).attr("src");
                        vue.active = true;
                    });
                });
            });
        </script>
        <!-- Docsify v4 -->
        <script src="../js/docsify.js"></script>
        <!-- emoji -->
        <script src="../js/emoji.js"></script>
        <!-- search box -->
        <script src="../js/search.js"></script>
        <!-- image -->
        <script src="../js/zoom.js"></script>
        <!-- image -->
        <script src="../js/zoom-en.js"></script>
        <!-- copy code -->
        <script src="../js/copy-code.js"></script>
        <!-- words count -->
        <script src="../js/count.js"></script>
        <!-- code highlight -->
        <script src="../js/prism-java.js"></script>
        <script src="../js/speech.js"></script>
        <script src="../js/reading-mode.js"></script>
        
        <!-- Export to PDF dependencies -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script>
            
            // Add export PDF button and reading mode buttons
            function addExportPDFButtons() {
                // Remove existing buttons and containers if any
                const existingElements = document.querySelectorAll('.export-pdf-btn, .reading-mode-btn, .recitation-mode-btn, .pdf-export-container, .control-panel-container');
                existingElements.forEach(el => el.remove());
                
                // Create control panel container
                const controlPanelContainer = document.createElement('div');
                controlPanelContainer.className = 'control-panel-container';
                controlPanelContainer.innerHTML = `
                    <div class="control-panel-header" onclick="toggleControlPanel()">
                        <span class="control-panel-title">ğŸ“‹ æ§åˆ¶é¢æ¿</span>
                        <span class="control-panel-toggle">â–¼</span>
                    </div>
                    <div class="control-panel-content" id="controlPanelContent">
                        <div class="control-panel-buttons"></div>
                    </div>
                `;
                
                // Set styles for control panel
                controlPanelContainer.style.cssText = `
                    position: fixed;
                    top: 10px;
                    right: 10px;
                    z-index: 9999;
                    background-color: rgba(255, 255, 255, 0.95);
                    border-radius: 10px;
                    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                    font-family: inherit;
                    font-size: 13px;
                    transition: all 0.3s ease;
                    max-width: 200px;
                    border: 1px solid rgba(0, 0, 0, 0.1);
                `;
                
                // Set styles for control panel header
                const header = controlPanelContainer.querySelector('.control-panel-header');
                header.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 10px 15px;
                    cursor: pointer;
                    border-radius: 10px;
                    background-color: #f8f9fa;
                    font-weight: 600;
                    color: #495057;
                    transition: all 0.3s ease;
                `;
                
                // Set styles for control panel toggle
                const toggle = controlPanelContainer.querySelector('.control-panel-toggle');
                toggle.style.cssText = `
                    transition: transform 0.3s ease;
                    font-size: 11px;
                `;
                
                // Set styles for control panel content
                const content = controlPanelContainer.querySelector('.control-panel-content');
                content.style.cssText = `
                    padding: 0;
                    max-height: 0;
                    overflow: hidden;
                    transition: all 0.3s ease;
                `;
                
                // Set styles for control panel buttons
                const buttonsContainer = controlPanelContainer.querySelector('.control-panel-buttons');
                buttonsContainer.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 8px;
                    padding: 15px;
                `;
                
                // Create image-based PDF export button
                const imageExportBtn = document.createElement('button');
                imageExportBtn.className = 'export-pdf-btn image-pdf-btn';
                imageExportBtn.innerHTML = 'ğŸ–¼ï¸ PDF';
                imageExportBtn.style.cssText = `
                    padding: 8px 16px;
                    background-color: #10b981;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 600;
                    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
                    transition: all 0.3s ease;
                    width: 100%;
                    text-align: center;
                    font-family: inherit;
                `;
                
                // Add hover effect for image button
                imageExportBtn.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#059669';
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 3px 12px rgba(16, 185, 129, 0.4)';
                });
                
                imageExportBtn.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#10b981';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(16, 185, 129, 0.3)';
                });
                
                // Create reading mode button
                const readingModeBtn = document.createElement('button');
                readingModeBtn.className = 'export-pdf-btn reading-mode-btn';
                readingModeBtn.innerHTML = 'ğŸ“– é˜…è¯»';
                readingModeBtn.style.cssText = `
                    padding: 8px 16px;
                    background-color: #8b5cf6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 600;
                    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
                    transition: all 0.3s ease;
                    width: 100%;
                    text-align: center;
                    font-family: inherit;
                `;
                
                // Add hover effect for reading mode button
                readingModeBtn.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#7c3aed';
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 3px 12px rgba(139, 92, 246, 0.4)';
                });
                
                readingModeBtn.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#8b5cf6';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(139, 92, 246, 0.3)';
                });
                
                // Create read this page button
                const readThisPageBtn = document.createElement('button');
                readThisPageBtn.className = 'read-this-page-btn';
                readThisPageBtn.innerHTML = 'ğŸ”Š é˜…è¯»æœ¬é¡µ';
                readThisPageBtn.style.cssText = `
                    padding: 8px 16px;
                    background-color: #3b82f6;
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 12px;
                    font-weight: 600;
                    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
                    transition: all 0.3s ease;
                    width: 100%;
                    text-align: center;
                    font-family: inherit;
                `;
                
                // Add hover effect for read this page button
                readThisPageBtn.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#2563eb';
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 3px 12px rgba(59, 130, 246, 0.4)';
                });
                
                readThisPageBtn.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '#3b82f6';
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(59, 130, 246, 0.3)';
                });
                
                // Append buttons to control panel
                buttonsContainer.appendChild(imageExportBtn);
                buttonsContainer.appendChild(readingModeBtn);
                buttonsContainer.appendChild(readThisPageBtn);
                
                // Append control panel to document
                document.body.appendChild(controlPanelContainer);
                
                // Add event listeners for reading mode
                readingModeBtn.addEventListener('click', function() {
                    toggleReadingMode();
                });
                
                // Add event listener for read this page
                readThisPageBtn.addEventListener('click', function() {
                    // Check if speech.js has initSpeechControls function
                    if (typeof initSpeechControls === 'function') {
                        initSpeechControls();
                        // Start reading if possible
                        if (typeof startReading === 'function') {
                            startReading();
                        }
                    } else {
                        alert('é˜…è¯»åŠŸèƒ½æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨å€™é‡è¯•');
                    }
                });
                
                // Image-based PDF export function
                imageExportBtn.addEventListener('click', function() {
                    // Show loading indicator
                    const originalText = imageExportBtn.innerHTML;
                    imageExportBtn.innerHTML = 'â³ æ­£åœ¨ç”Ÿæˆå›¾ç‰‡ç‰ˆPDF...';
                    imageExportBtn.disabled = true;
                    
                    // Get content to export
                    const content = document.querySelector('.markdown-section');
                    if (!content) {
                        alert('æœªæ‰¾åˆ°è¦å¯¼å‡ºçš„å†…å®¹');
                        imageExportBtn.innerHTML = originalText;
                        imageExportBtn.disabled = false;
                        return;
                    }
                    
                    // Apply temporary styles for A4 compatibility while preserving original styles
                    const pdfStyle = document.createElement('style');
                    pdfStyle.id = 'pdf-font-style';
                    pdfStyle.textContent = `
                        /* åŸºç¡€æ ·å¼é‡ç½® */
                        body {
                            margin: 0 !important;
                            padding: 0 !important;
                            background: white !important;
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
                        }
                        
                        /* ä¸»è¦å†…å®¹å®¹å™¨æ ·å¼ */
                        .markdown-section {
                            width: 794px !important; /* å›ºå®šA4å®½åº¦ */
                            max-width: 794px !important;
                            margin: 0 auto !important;
                            padding: 25px !important;
                            background: white !important;
                            box-shadow: none !important;
                            border: none !important;
                            color: #333 !important;
                            line-height: 1.6 !important;
                        }
                        
                        /* æ ‡é¢˜æ ·å¼ */
                        h1 {
                            font-size: 24px !important;
                            font-weight: bold !important;
                            color: #2c3e50 !important;
                            margin: 24px 0 16px 0 !important;
                            padding-bottom: 8px !important;
                            border-bottom: 2px solid #e0e0e0 !important;
                        }
                        
                        h2 {
                            font-size: 20px !important;
                            font-weight: bold !important;
                            color: #34495e !important;
                            margin: 20px 0 14px 0 !important;
                            padding-bottom: 6px !important;
                            border-bottom: 1px solid #e0e0e0 !important;
                        }
                        
                        h3 {
                            font-size: 18px !important;
                            font-weight: bold !important;
                            color: #34495e !important;
                            margin: 18px 0 12px 0 !important;
                        }
                        
                        h4, h5, h6 {
                            font-size: 16px !important;
                            font-weight: bold !important;
                            color: #34495e !important;
                            margin: 16px 0 10px 0 !important;
                        }
                        
                        /* æ®µè½æ ·å¼ */
                        p {
                            font-size: 14px !important;
                            line-height: 1.6 !important;
                            color: #333 !important;
                            margin: 12px 0 !important;
                            text-align: justify !important;
                            text-indent: 28px !important;
                        }
                        
                        /* åˆ—è¡¨æ ·å¼ */
                        ul, ol {
                            font-size: 14px !important;
                            line-height: 1.6 !important;
                            color: #333 !important;
                            margin: 12px 0 !important;
                            padding-left: 24px !important;
                        }
                        
                        ul li, ol li {
                            margin: 8px 0 !important;
                            padding-left: 8px !important;
                        }
                        
                        /* ä»£ç æ ·å¼ */
                        pre {
                            background-color: #f6f8fa !important;
                            border: 1px solid #e1e4e8 !important;
                            border-radius: 6px !important;
                            padding: 16px !important;
                            margin: 16px 0 !important;
                            overflow: auto !important;
                            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;
                        }
                        
                        code {
                            background-color: #f6f8fa !important;
                            border: 1px solid #e1e4e8 !important;
                            border-radius: 3px !important;
                            padding: 2px 6px !important;
                            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;
                            font-size: 13px !important;
                            color: #e83e8c !important;
                        }
                        
                        pre code {
                            background-color: transparent !important;
                            border: none !important;
                            padding: 0 !important;
                            color: #24292e !important;
                        }
                        
                        /* é“¾æ¥æ ·å¼ */
                        a {
                            color: #0366d6 !important;
                            text-decoration: none !important;
                        }
                        
                        a:hover {
                            text-decoration: underline !important;
                        }
                        
                        /* è¡¨æ ¼æ ·å¼ */
                        table {
                            width: 100% !important;
                            border-collapse: collapse !important;
                            margin: 16px 0 !important;
                            font-size: 14px !important;
                        }
                        
                        th, td {
                            border: 1px solid #e1e4e8 !important;
                            padding: 8px 12px !important;
                            text-align: left !important;
                        }
                        
                        th {
                            background-color: #f6f8fa !important;
                            font-weight: bold !important;
                            color: #24292e !important;
                        }
                        
                        /* å¼•ç”¨æ ·å¼ */
                        blockquote {
                            border-left: 4px solid #dfe2e5 !important;
                            padding: 10px 16px !important;
                            margin: 16px 0 !important;
                            background-color: #f8f9fa !important;
                            color: #6a737d !important;
                            font-style: italic !important;
                        }
                        
                        /* å¼ºè°ƒæ ·å¼ */
                        strong {
                            font-weight: bold !important;
                            color: #d73a49 !important;
                        }
                        
                        em {
                            font-style: italic !important;
                        }
                        
                        /* åˆ—è¡¨é¡¹ç¬¦å· */
                        ul li {
                            list-style-type: disc !important;
                        }
                        
                        ol li {
                            list-style-type: decimal !important;
                        }
                        
                        /* å›¾ç‰‡æ ·å¼ */
                        img {
                            max-width: 100% !important;
                            height: auto !important;
                            margin: 16px auto !important;
                            display: block !important;
                            border-radius: 4px !important;
                        }
                        
                        /* æ°´å¹³åˆ†éš”çº¿ */
                        hr {
                            border: 0 !important;
                            border-top: 1px solid #eaecef !important;
                            margin: 24px 0 !important;
                        }
                    `;
                    document.head.appendChild(pdfStyle);
                    
                    // Export as image-based PDF using html2canvas
                    try {
                        // Capture content as image with html2canvas at higher quality
                        html2canvas(content, {
                            scale: 3, // Increase scale to 3 for much better quality
                            useCORS: true, // Allow cross-origin images
                            windowWidth: content.scrollWidth,
                            windowHeight: content.scrollHeight,
                            backgroundColor: '#ffffff' // Ensure white background
                        }).then(canvas => {
                            // Convert canvas to image data
                            const imgData = canvas.toDataURL('image/jpeg', 0.95); // 0.95 quality for better image clarity
                            
                            // Create PDF document
                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF('p', 'mm', 'a4');
                            
                            // Page dimensions
                            const pageWidth = pdf.internal.pageSize.getWidth();
                            const pageHeight = pdf.internal.pageSize.getHeight();
                            
                            // Calculate image dimensions
                            const imgWidth = pageWidth;
                            const imgHeight = (canvas.height * imgWidth) / canvas.width;
                            
                            // Add first page
                            pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                            
                            // Handle multiple pages if needed
                            let remainingHeight = imgHeight - pageHeight;
                            let page = 1;
                            
                            while (remainingHeight > 0) {
                                pdf.addPage();
                                pdf.addImage(imgData, 'JPEG', 0, -pageHeight * page, imgWidth, imgHeight);
                                remainingHeight -= pageHeight;
                                page++;
                                
                                if (page > 100) {
                                    alert('æ–‡æ¡£å†…å®¹è¿‡å¤šï¼Œå·²è‡ªåŠ¨æˆªæ–­ã€‚å»ºè®®åˆ†ç« èŠ‚å¯¼å‡ºä»¥è·å¾—å®Œæ•´å†…å®¹ã€‚');
                                    break;
                                }
                            }
                            // Save the PDF
                            pdf.save('èŒä¸šè€ƒè¯•ç¬”è®°-å›¾ç‰‡ç‰ˆ.pdf');
                            
                            // Remove temporary styles
                            const tempStyle = document.getElementById('pdf-font-style');
                            if (tempStyle) {
                                document.head.removeChild(tempStyle);
                            }
                            
                            // Restore button states
                            imageExportBtn.innerHTML = originalText;
                            imageExportBtn.disabled = false;
                            
                        }).catch(error => {
                            throw error;
                        });
                        
                    } catch (error) {
                        console.error('PDFç”Ÿæˆé”™è¯¯:', error);
                        
                        // Remove temporary styles
                        const tempStyle = document.getElementById('pdf-font-style');
                        if (tempStyle) {
                            document.head.removeChild(tempStyle);
                        }
                        
                        // Restore button states
                        imageExportBtn.disabled = false;
                        imageExportBtn.innerHTML = 'ğŸ–¼ï¸ å›¾ç‰‡ç‰ˆPDF';
                        
                        // Show error message
                        alert('PDFå¯¼å‡ºå¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯') + '\nè¯·é‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                    }
                });
            }
            
            // Check if .markdown-section exists
            function checkContentLoaded() {
                const content = document.querySelector('.markdown-section');
                if (content) {
                    addExportPDFButtons();
                } else {
                    // Check again in 500ms
                    setTimeout(checkContentLoaded, 500);
                }
            }
            
            // Start checking after DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                checkContentLoaded();
            });
            
            // Toggle control panel visibility
            function toggleControlPanel() {
                const content = document.getElementById('controlPanelContent');
                const toggle = document.querySelector('.control-panel-toggle');
                
                if (content && toggle) {
                    if (content.style.maxHeight === '' || content.style.maxHeight === '0px') {
                        // Expand the panel
                        content.style.maxHeight = content.scrollHeight + 'px';
                        toggle.style.transform = 'rotate(180deg)';
                    } else {
                        // Collapse the panel
                        content.style.maxHeight = '0px';
                        toggle.style.transform = 'rotate(0deg)';
                    }
                }
            }
            
            // Also check when hash changes (Docsify page navigation)
            window.addEventListener('hashchange', function() {
                checkContentLoaded();
            });
        </script>
    </body>
</html>
